name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  claude-code-action:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Claude PR Review
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          timeout_minutes: "60" 
          direct_prompt: |
            Perform an exhaustive code review of the changed files in this pull request.
            
            Changed files: ${{ steps.changed-files.outputs.all_changed_files }}
            
            For each file:
            
            1. Add inline comments explaining:
               - What each function/method does
               - Complex logic or algorithms
               - Potential issues or improvements
               - Best practice violations
               - Security concerns
               - Performance optimizations
            
            2. Use these comment prefixes:
               // BUG: [Critical issues that must be fixed]
               // SECURITY: [Security vulnerabilities]
               // PERF: [Performance issues]
               // TODO: [Required changes]
               // SUGGESTION: [Optional improvements]
               // EXPLAIN: [Code explanations]
            
            3. Check for:
               - Input validation issues
               - SQL injection vulnerabilities
               - XSS prevention gaps
               - Error handling
               - Memory leaks
               - Race conditions
               - Test coverage gaps
               - Code duplication
               - SOLID principle violations
            
            4. Provide a summary with:
               - Overall code quality score (1-10)
               - Critical issues count
               - Security issues count
               - Performance concerns
               - Test coverage assessment
               - Recommended actions prioritized by severity
            
            Format the output as GitHub-compatible markdown.
          
          files: ${{ steps.changed-files.outputs.all_changed_files }}
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          DISABLE_NON_ESSENTIAL_MODEL_CALLS: 1
          