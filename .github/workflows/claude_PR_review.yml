name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  claude-code-action:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # Identify the files and lines changed in this PR
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          since_last_remote_commit: "true"

      - name: Claude PR Review
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          timeout_minutes: "60"
          allowed_tools: "Bash(git:*),View,GlobTool,GrepTool,mcp__github__create_pending_pull_request_review,mcp__github__add_pull_request_review_comment_to_pending_review,mcp__github__submit_pending_pull_request_review"
          direct_prompt: |
            Please review this pull request and provide comprehensive feedback.

            Focus on:
            - Code quality and best practices
            - Potential bugs or issues
            - Performance considerations
            - Security implications

            Review ONLY these files:
            ${{ steps.changed-files.outputs.all_changed_files }}

            ‚Ä¢ Start by calling `mcp__github__create_pending_pull_request_review` with:
              owner: "${{ github.repository_owner }}"
              repo: "${{ github.event.repository.name }}"
              pullNumber: ${{ github.event.pull_request.number }}

            ‚Ä¢ For every issue you find, immediately call `mcp__github__add_pull_request_review_comment_to_pending_review` (same owner/repo/pullNumber) with:
              path, line, side="RIGHT", body starting with one of these emoji-label prefixes:
                üêû *BUG*: <text>
                üîí *SECURITY*: <text>
                üöÄ *PERF*: <text>
                üí° *SUGGESTION*: <text>
                üìù *EXPLAIN*: <text>

            ‚Ä¢ For üêû *BUG* items:
                ‚Äì If (and only if) you are 100 % certain of the fix, include a GitHub code suggestion in the body using the markdown syntax:
                  ```suggestion
                  // replacement code here
                  ```
                ‚Äì If not completely sure, just describe the bug without a suggestion block.

            ‚Ä¢ After all comments, call `mcp__github__submit_pending_pull_request_review` with event="COMMENT" and a high-level brief summary in body (include overall quality score, counts, etc.).

            Do NOT output raw JSON or markdown. Use the provided MCP tools to leave inline comments directly on the PR.
          
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          DISABLE_NON_ESSENTIAL_MODEL_CALLS: 1